---
title: SQL Server R Services のパフォーマンス チューニング
ms.prod: sql
ms.technology: machine-learning
ms.date: 04/15/2018
ms.topic: conceptual
author: dphansen
ms.author: davidph
monikerRange: '>=sql-server-2016||>=sql-server-linux-ver15||=sqlallproducts-allversions'
ms.openlocfilehash: dd12e38e0d1f01cd142cc4c11efe43346dd1f8ce
ms.sourcegitcommit: 321497065ecd7ecde9bff378464db8da426e9e14
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/01/2019
ms.locfileid: "68715618"
---
# <a name="performance-tuning-for-r-in-sql-server"></a>SQL Server での R のパフォーマンスチューニング
[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md](../../includes/appliesto-ss-xxxx-xxxx-xxx-md.md)]

この記事は、次の2つのケーススタディに基づいて、R Services のパフォーマンスの最適化について説明する一連の4つの記事の最初の記事です。

- R ソリューションのパフォーマンスプロファイルを検証するために製品開発チームによって実行されるパフォーマンステスト

- 多くの場合、顧客によって要求される特定の機械学習シナリオに対する、Microsoft データサイエンスチームによるパフォーマンスの最適化。

このシリーズの目的は、SQL Server で R ジョブを実行する際に最も役立つパフォーマンスチューニング手法の種類に関するガイダンスを提供することです。

+ この (最初) トピックでは、データサイエンスタスクを最適化する際にアーキテクチャの概要と一般的な問題について説明します。
+ 2番目の記事では、特定のハードウェアと SQL Server の最適化について説明します。
+ 3番目の記事では、R コードの最適化と運用化に関するリソースについて説明します。
+ 4番目の記事では、テストメソッドについて詳しく説明し、結果と結論を報告します。

**適用対象:** SQL Server 2016 R Services、SQL Server Machine Learning Services

## <a name="performance-goals-and-targeted-scenarios"></a>パフォーマンス目標と対象となるシナリオ

R Services 機能は、SQL Server による R スクリプトの実行をサポートするために SQL Server 2016 で導入されました。 この機能を使用すると、R ランタイムはデータベースエンジンとは別のプロセスで動作しますが、信頼されたスタートパッドなどの SQL Server と対話するサーバーリソースとサービスを使用して、データベースエンジンとデータを安全に交換します。

SQL Server 2017 では、同じアーキテクチャを使用して Python スクリプトを実行するためのサポートが発表されました。さらに言語を追加することもできます。

サポートされているバージョンと言語の数が増えるにつれて、データベース管理者とデータベース設計者は、machine learning ジョブに起因するリソースの競合の可能性を認識し、サーバーがをサポートするように構成できることが重要です。新しいワークロード。 データの近くに分析を続けると、安全ではないデータの移動が排除されますが、分析ワークロードはデータサイエンスのラップトップから移動し、データをホストしているサーバーに戻ることができます。

機械学習のパフォーマンスの最適化は、1つのサイズに適合するすべての提案ではありません。 次の一般的なタスクには、パフォーマンスプロファイルが大きく異なる場合があります。

- トレーニングタスク: 回帰モデルの作成とトレーニングおよびニューラルネットワークのトレーニング
- T-sql を使用した R と特徴の抽出を使用した特徴エンジニアリング
- 単一行または小さいバッチに対するスコアリング、およびテーブル入力を使用した一括スコアリング
- R でのスコアリングの実行と、ストアドプロシージャ内の SQL Server での運用環境へのモデルの配置
- データ転送を最小限にする R コードを変更する、またはコストのかかるデータ変換を削除する
- モデルの自動テストと再トレーニングを有効にする

最適化手法の選択肢は、アプリケーションまたはユースケースにとって重要なタスクによって異なります。そのため、ケーススタディでは、一般的なパフォーマンスのヒントと、特定のシナリオに最適化する方法に関するガイダンス (バッチスコアリングの最適化) について説明します。

+ **SQL Server の個々の最適化オプション**

    最初のパフォーマンスケーススタディでは、1つの種類のモデルを使用して、1つのデータセットに対して複数のテストを実行しました。 RevoscaleR の rxLinMod アルゴリズムを使用してモデルを構築し、そこからスコアを作成しましたが、コードと基になるデータテーブルが体系的に変更され、各変更の影響をテストしました。

    たとえば、あるテストの実行で R コードが変更され、変換関数を使用して特徴エンジニアリング間で比較を行うことができるようになりました。また、機能を事前に計算してから、テーブルから機能を読み込むこともできます。 別のテストの実行では、モデルトレーニングのパフォーマンスが、標準のインデックス付きテーブルと、さまざまな種類の圧縮または新しいインデックスの種類を持つテーブル内のデータのどちらを使用しているかを比較しました。

+ **特定の大規模なスコアリングシナリオの最適化**

    2番目のケーススタディの機械学習タスクでは、複数の職位に対して送信された多数の再開処理と、各ジョブの位置に最適な候補の検索が含まれます。 機械学習モデル自体は、二項分類の問題として定義されています。これは、再開とジョブの説明を入力として受け取り、各再開ジョブペアの確率を生成します。 最適な一致を見つけることが目的であるため、ユーザー定義の確率しきい値を使用してさらにフィルター処理し、適切な一致だけを取得します。

    このソリューションでは、主な目的はスコアリング中に低待機時間を実現することでした。 ただし、このタスクでは、スコア付けプロセス中でも計算コストが高くなります。各新しいジョブは、妥当な時間内に何百万もの再開と照合される必要があるためです。 さらに、特徴エンジニアリングの手順では、再開またはジョブごとに2000を超える機能が生成され、パフォーマンスが大幅に低下します。

最初のケーススタディから得られたすべての結果を確認して、ソリューションに適用できる手法を特定し、潜在的な影響を比較することをお勧めします。

次に、スコアリング最適化のケーススタディの結果を確認して、作成者がさまざまな手法を適用し、特定のワークロードをサポートするようにサーバーを最適化した方法を確認します。

## <a name="performance-optimization-process"></a>パフォーマンスの最適化プロセス

パフォーマンスの構成とチューニングには、特定のワークロード向けに設計されたレイヤーの最適化を行うためのソリッドベースを作成する必要があります。

- 分析をホストする適切なサーバーを選択します。 通常は、他のレポートまたは分析に既に使用されているレポートセカンダリ、データウェアハウス、またはその他のサーバーを使用することをお勧めします。 ただし、ハイブリッドトランザクション分析処理 (HTAP) ソリューションでは、操作データを R への入力として使用して高速スコアリングを行うことができます。

- データベースエンジンの操作と R または Python スクリプトの実行を適切なレベルで調整するように、SQL Server インスタンスを構成します。 これには、メモリと CPU 使用率、NUMA とプロセッサのアフィニティ設定、およびリソースグループの作成に関する SQL Server の既定値の変更が含まれます。

- サーバーコンピューターを最適化して、外部スクリプトの効率的な使用をサポートします。 これには、外部スクリプトの実行に使用するアカウントの数の増加、パッケージ管理の有効化、および関連するセキュリティロールへのユーザーの割り当てが含まれます。

- SQL Server でのデータの格納と転送に固有の最適化の適用 (インデックス作成と統計の方法、クエリのデザインとクエリの最適化、機械学習に使用するテーブルの設計など)。 また、データソースとデータ転送方法を分析したり、ETL プロセスを変更して機能の抽出を最適化したりすることもできます。

- 分析モデルを調整して、非効率性を回避します。 可能な最適化のスコープは、R コードの複雑さと、使用しているパッケージとデータによって異なります。 主要なタスクとしては、コストの高いデータ変換の排除や、R または Python から ETL プロセスまたは SQL へのデータ準備タスクや機能エンジニアリングタスクがあります。 また、スクリプトをリファクターし、インラインパッケージのインストールを排除し、R コードをトレーニング、スコアリング、評価のための個別のプロシージャに分割したり、コードを単純化してストアドプロシージャとして効率的に作業したりすることもできます。

## <a name="articles-in-this-series"></a>このシリーズの記事

+ [SQL Server の R のパフォーマンスチューニング-ハードウェア](../r/sql-server-configuration-r-services.md)

    にインストールされているハードウェア[!INCLUDE[ssNoVersion_md](../../includes/ssnoversion-md.md)]の構成と、外部スクリプトをより適切にサポートするための SQL Server インスタンスの構成に関するガイダンスを提供します。 これは、**データベース管理者**にとって特に便利です。

+ [SQL Server の R のパフォーマンスチューニング-コードとデータの最適化](../r/r-and-data-optimization-r-services.md)

    既知の問題を回避するために外部スクリプトを最適化する方法について、具体的なヒントを提供します。 これは、**データ科学**者にとって最も役に立ちます。

    > [!NOTE]
    > このセクションの情報の多くは、一般に R に適用されますが、一部の情報は RevoScaleR 分析関数に固有のものです。 **Revoscalepy**およびその他のサポートされている Python ライブラリでは、詳細なパフォーマンスガイダンスを利用できません。
    >

+ [SQL Server の R のパフォーマンスチューニング-メソッドと結果](../r/performance-case-study-r-services.md)

    2つのケーススタディで使用されたデータ、パフォーマンスのテスト方法、およびその影響を受けた最適化の結果をまとめます。
